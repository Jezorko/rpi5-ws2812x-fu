#include <stdint.h>
#include <stdio.h>
#include <stdbool.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <stddef.h>

// pci bar info
// from: https://github.com/G33KatWork/RP1-Reverse-Engineering/blob/master/pcie/hacks.py
#define RP1_BAR1 0x1f00000000
#define RP1_BAR1_LEN 0x400000

// offsets from include/dt-bindings/mfd/rp1.h
// https://github.com/raspberrypi/linux/blob/rpi-6.1.y/include/dt-bindings/mfd/rp1.h
#define RP1_IO_BANK0_BASE 0x0d0000
#define RP1_RIO0_BASE 0x0e0000
#define RP1_PADS_BANK0_BASE 0x0f0000

// the following info is from the RP1 datasheet (draft & incomplete as of 2024-02-18)
// https://datasheets.raspberrypi.com/rp1/rp1-peripherals.pdf
#define RP1_ATOM_XOR_OFFSET 0x1000
#define RP1_ATOM_SET_OFFSET 0x2000
#define RP1_ATOM_CLR_OFFSET 0x3000

#define PADS_BANK0_VOLTAGE_SELECT_OFFSET 0
#define PADS_BANK0_GPIO_OFFSET 0x4

#define RIO_OUT_OFFSET 0x00
#define RIO_OE_OFFSET 0x04
#define RIO_NOSYNC_IN_OFFSET 0x08
#define RIO_SYNC_IN_OFFSET 0x0C
//                           3         2         1
//                          10987654321098765432109876543210
#define CTRL_MASK_FUNCSEL 0b00000000000000000000000000011111
#define PADS_MASK_OUTPUT  0b00000000000000000000000011000000

#define CTRL_FUNCSEL_RIO 0x05



////////////////////////////////////////////////////
// SPI
#define RP1_SPI8_BASE 0x04c000  // not available on gpio
#define RP1_SPI0_BASE 0x050000
#define RP1_SPI1_BASE 0x054000
#define RP1_SPI2_BASE 0x058000
#define RP1_SPI3_BASE 0x05c000
#define RP1_SPI4_BASE 0x060000
#define RP1_SPI5_BASE 0x064000
#define RP1_SPI6_BASE 0x068000  // not available on gpio
#define RP1_SPI7_BASE 0x06c000  // not available on gpio

typedef struct
{
    uint8_t number;
    volatile uint32_t *status;
    volatile uint32_t *ctrl;
    volatile uint32_t *pad;
} gpio_pin_t;

typedef struct {

    volatile void *regbase;
    char *txdata;
    char *rxdata;
    uint8_t txcount;

} rp1_spi_instance_t;

typedef struct
{
    volatile void *rp1_peripherial_base;
    volatile void *gpio_base;
    volatile void *pads_base;
    volatile uint32_t *rio_out;
    volatile uint32_t *rio_output_enable;
    volatile uint32_t *rio_nosync_in;

    gpio_pin_t *pins[27];
    rp1_spi_instance_t *spis[6];

} rp1_t;

// from: https://github.com/raspberrypi/linux/blob/rpi-6.1.y/drivers/spi/spi-dw.h

/* Register offsets (Generic for both DWC APB SSI and DWC SSI IP-cores) */
// many of the descriptions below were auto-filled by co-pilot, so they may not be accurate // why the fuck would you do that then!!!
// second comments are second suggestions by co-pilot
#define DW_SPI_CTRLR0 0x00 // control register 0 (frame format, clock polarity, phase, etc.)
#define DW_SPI_CTRLR1 0x04 // control register 1 (number of data frames)
#define DW_SPI_SSIENR 0x08 // enable register (enable/disable the SPI controller)
#define DW_SPI_MWCR 0x0c // Microwire control register (not used in SPI mode)
#define DW_SPI_SER 0x10     // chip select, bit = chip select line? see dw_spi_set_cs()   // slave enable register
#define DW_SPI_BAUDR 0x14 // baud rate register // author: verified on the Pi5 to be a straight divisor of 200MHz clk_sys
#define DW_SPI_TXFTLR 0x18 // seems to be the number of bytes in the TX FIFO // transmit FIFO threshold level
#define DW_SPI_RXFTLR 0x1c // seems to be the number of bytes in the RX FIFO // receive FIFO threshold level
#define DW_SPI_TXFLR 0x20   // seems to be the number of bytes in the TX FIFO // transmit FIFO level
#define DW_SPI_RXFLR 0x24  // seems to be the number of bytes in the RX FIFO // receive FIFO level
#define DW_SPI_SR 0x28     // status register
#define DW_SPI_IMR 0x2c   // interrupt mask register
#define DW_SPI_ISR 0x30  // interrupt status register
#define DW_SPI_RISR 0x34  // raw interrupt status register
#define DW_SPI_TXOICR 0x38 // transmit FIFO overflow interrupt clear register
#define DW_SPI_RXOICR 0x3c // receive FIFO overflow interrupt clear register
#define DW_SPI_RXUICR 0x40 // receive FIFO underflow interrupt clear register
#define DW_SPI_MSTICR 0x44  // multi-master interrupt clear register
#define DW_SPI_ICR 0x48 // interrupt clear register
#define DW_SPI_DMACR 0x4c // DMA control register
#define DW_SPI_DMATDLR 0x50 // DMA transmit data level register
#define DW_SPI_DMARDLR 0x54 // DMA receive data level register
#define DW_SPI_IDR 0x58 // Identification register
#define DW_SPI_VERSION 0x5c     // version register
#define DW_SPI_DR 0x60 // data register
#define DW_SPI_RX_SAMPLE_DLY 0xf0   // receive sample delay register
#define DW_SPI_CS_OVERRIDE 0xf4 // chip select override register

//  Each SSI controller is based on a configuration of the Synopsys DW_apb_ssi IP (v4.02a).
// APB
/* Bit fields in CTRLR0 (DWC APB SSI) */
//                                     3         2         1
//                                    10987654321098765432109876543210

#define DW_PSSI_CTRLR0_DFS_MASK     0b00000000000000000000000000001111 //GENMASK(3, 0)
#define DW_PSSI_CTRLR0_DFS32_MASK   0b00000000000111110000000000000000 //GENMASK(20, 16)

#define DW_PSSI_CTRLR0_FRF_MASK     0b00000000000000000000000000110000 //GENMASK(5, 4)
#define DW_SPI_CTRLR0_FRF_MOTO_SPI 0x0
#define DW_SPI_CTRLR0_FRF_TI_SSP 0x1
#define DW_SPI_CTRLR0_FRF_NS_MICROWIRE 0x2
#define DW_SPI_CTRLR0_FRF_RESV 0x3

#define DW_PSSI_CTRLR0_MODE_MASK    0b00000000000000000000000011000000 //GENMASK(7, 6)
#define DW_PSSI_CTRLR0_SCPHA        0b00000000000000000000000001000000 // BIT(6)
#define DW_PSSI_CTRLR0_SCPOL        0b00000000000000000000000010000000 //BIT(7)

#define DW_PSSI_CTRLR0_TMOD_MASK    0b00000000000000000000001100000000// GENMASK(9, 8)
#define DW_SPI_CTRLR0_TMOD_TR 0x0        /* xmit & recv */
#define DW_SPI_CTRLR0_TMOD_TO 0x1        /* xmit only */
#define DW_SPI_CTRLR0_TMOD_RO 0x2        /* recv only */
#define DW_SPI_CTRLR0_TMOD_EPROMREAD 0x3 /* eeprom read mode */

#define DW_PSSI_CTRLR0_SLV_OE       0b00000000000000000000010000000000 // BIT(10)
#define DW_PSSI_CTRLR0_SRL          0b00000000000000000000100000000000 // BIT(11)
#define DW_PSSI_CTRLR0_CFS          0b00000000000000000001000000000000 // BIT(12)

/* Bit fields in CTRLR0 (DWC SSI with AHB interface) - not relevant in the RP1 */
#define DW_HSSI_CTRLR0_DFS_MASK     0b00000000000000000000000000011111 // GENMASK(4, 0)
#define DW_HSSI_CTRLR0_FRF_MASK     0b00000000000000000000000011000000 // GENMASK(7, 6)
#define DW_HSSI_CTRLR0_SCPHA        0b00000000000000000000000100000000 // BIT(8)
#define DW_HSSI_CTRLR0_SCPOL        0b00000000000000000000001000000000 // BIT(9)
#define DW_HSSI_CTRLR0_TMOD_MASK    0b00000000000000000000011000000000 // GENMASK(11, 10)
#define DW_HSSI_CTRLR0_SRL          0b00000000000000000001000000000000 // BIT(13)
#define DW_HSSI_CTRLR0_MST          0b10000000000000000000000000000000 // BIT(31)

/* Bit fields in CTRLR1 */
#define DW_SPI_NDF_MASK             0b00000000000000001111111111111111 // GENMASK(15, 0) // Number of data frames

/* Bit fields in SR, 7 bits */
#define DW_SPI_SR_MASK              0b00000000000000000000000001111111 // GENMASK(6, 0)
#define DW_SPI_SR_BUSY              0b00000000000000000000000000000001 // BIT(0)
#define DW_SPI_SR_TF_NOT_FULL       0b00000000000000000000000000000010 // BIT(1)
#define DW_SPI_SR_TF_EMPT           0b00000000000000000000000000000100 // BIT(2)
#define DW_SPI_SR_RF_NOT_EMPT       0b00000000000000000000000000001000 // BIT(3)
#define DW_SPI_SR_RF_FULL           0b00000000000000000000000000010000 // BIT(4)
#define DW_SPI_SR_TX_ERR            0b00000000000000000000000000100000 // BIT(5)
#define DW_SPI_SR_DCOL              0b00000000000000000000000001000000 // BIT(6)

/* Bit fields in ISR, IMR, RISR, 7 bits */
#define DW_SPI_INT_MASK             0b00000000000000000000000000111111 // GENMASK(5, 0)
#define DW_SPI_INT_TXEI             0b00000000000000000000000000000001 // BIT(0) TX FIFO empty
#define DW_SPI_INT_TXOI             0b00000000000000000000000000000010 // BIT(1) TX FIFO overflow
#define DW_SPI_INT_RXUI             0b00000000000000000000000000000100 // BIT(2) RX FIFO underflow
#define DW_SPI_INT_RXOI             0b00000000000000000000000000001000 // BIT(3) RX FIFO overflow
#define DW_SPI_INT_RXFI             0b00000000000000000000000000010000 // BIT(4) RX FIFO full
#define DW_SPI_INT_MSTI             0b00000000000000000000000000100000 // BIT(5) Multi-Master contention

/* Bit fields in DMACR */
#define DW_SPI_DMACR_RDMAE          0b00000000000000000000000000000001 // BIT(0)
#define DW_SPI_DMACR_TDMAE          0b00000000000000000000000000000010 // BIT(1)
//                                    10987654321098765432109876543210
//                                     3         2         1



const uint32_t spi_bases[] = {
    RP1_SPI0_BASE,
    RP1_SPI1_BASE,
    RP1_SPI2_BASE,
    RP1_SPI3_BASE,
    RP1_SPI4_BASE,
    RP1_SPI5_BASE,
    RP1_SPI6_BASE,
    RP1_SPI7_BASE,
    RP1_SPI8_BASE
};

bool rp1_spi_create(rp1_t *rp1, uint8_t spinum, rp1_spi_instance_t **spi)
{

    rp1_spi_instance_t *s = (rp1_spi_instance_t *)calloc(1, sizeof(rp1_spi_instance_t));
    if (s == NULL)
        return false;

    s->regbase = rp1->rp1_peripherial_base + spi_bases[spinum];
    s->txdata = (char *)0x0;
    s->rxdata = (char *)0x0;
    s->txcount = 0x0;

    *spi = s;

    return true;
}

// according to https://wp.josh.com/2014/05/13/ws2812-neopixels-are-not-so-finicky-once-you-get-to-know-them/
// since we transmit 50ns at a time (20MHz) we will need to transmit 3 bytes (24 bits, 1200ns) per byte of data
// most fitting timings would be:
// ON 13 (650ns/50) bits high, 11 (550ns/50) bits low
// 11111111 11111000 00000000
// 0xff     0xf8     0x00
// OFF 7 (350ns/50) bits high, 17 (850ns/50) bits low
// 11111110 00000000 00000000
// 0xfe     0x00     0x00
// and to reset/latch
// RES 120 bits low (6000ns/50) == 15 bytes
// uint8_t on[3]  = { 0xff, 0xf8, 0x00 };
// uint8_t off[3] = { 0xfe, 0x00, 0x00 };
//
// OK, with 20MHz it's not setting the LEDs correctly
// guessing there's some flicker on the wire
// so we will use 10MHz and in this case we need 2 bytes per bit
// ON 7 (700ns) bits high, 9 (900ns) bits low
// 11111110 00000000
// 0xfe     0x00
// OFF 4 (400ns) bits high, 12 (1200ns) bits low
// 11110000 00000000
// 0xf0     0x00
//
// This will need 1600ns instead of 1200ns per byte of data which is ~30% slower, but that's fine.
// Given 60 LEDs, with 20MHz we need 1200ns * 3 (for each color) * 60 (for each led) == 216 microseconds.
// With 10MHz we need 288 microseconds.
// That's a difference of 72 microseconds per 60 LEDs, or ~1 microsecond per LED.
// With 1000 LEDs, that's 1 millisecond difference (that's still fast enough to render at 144 FPS).
// But I have 120 LEDs.
// So I don't care.

// instead of transforming one bit at a time, we will just read from a lookup table
// cause screw it, it's Raspberry 5, we got a ton of memory anyways
uint8_t lookup_table[256][16] = {
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xf0, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 },
    { 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0xfe, 0x00 }
};

void rp1_spi_write_array_blocking(rp1_spi_instance_t *spi, uint8_t data[], int data_length)
{
    while(*(volatile uint32_t *)(spi->regbase + DW_SPI_SR) & DW_SPI_SR_BUSY)
    {
        /* wait until the spi is not busy */;
    }

    while(!(*(volatile uint32_t *)(spi->regbase + DW_SPI_SR) & DW_SPI_SR_TF_NOT_FULL))
    {
       /* spin until we can write to the fifo */;
    }

    // set the CS pin
    *(volatile uint32_t *)(spi->regbase + DW_SPI_SER) = 1 <<0;

    for (int data_byte = 0; data_byte < data_length; ++data_byte) {
        for (int bits_byte = 0; bits_byte < 16; ++bits_byte) {
            // put the data into the fifo
            *(volatile uint8_t *)(spi->regbase + DW_SPI_DR) = lookup_table[data[data_byte]][bits_byte];
            // we now need to pull exactly one byte out of the fifo which would
            // have been clocked in when we wrote the data
            /*uint8_t discard = */*(volatile uint8_t *)(spi->regbase + DW_SPI_DR);
        }
    }
}



void *mapgpio(off_t dev_base, off_t dev_size)
{
    int fd;
    void *mapped;

    // printf("sizeof(off_t) %d\n", sizeof(off_t));

    if ((fd = open("/dev/mem", O_RDWR | O_SYNC)) == -1)
    {
        printf("Can't open /dev/mem\n");
        return (void *)0;
    }

    mapped = mmap(0, dev_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, dev_base);
    // close(fd);

    // printf("base address: %llx, size: %x, mapped: %p\n", dev_base, dev_size, mapped);

    if (mapped == (void *)-1)
    {
        printf("Can't map the memory to user space.\n");
        return (void *)0;
    }

    return mapped;
}



bool create_rp1(rp1_t **rp1, void *base)
{

    rp1_t *r = (rp1_t *)calloc(1, sizeof(rp1_t));
    if (r == NULL)
        return false;

    r->rp1_peripherial_base = base;
    r->gpio_base = base + RP1_IO_BANK0_BASE;
    r->pads_base = base + RP1_PADS_BANK0_BASE;
    r->rio_out = (volatile uint32_t *)(base + RP1_RIO0_BASE + RIO_OUT_OFFSET);
    r->rio_output_enable = (volatile uint32_t *)(base + RP1_RIO0_BASE + RIO_OE_OFFSET);
    r->rio_nosync_in = (volatile uint32_t *)(base + RP1_RIO0_BASE + RIO_NOSYNC_IN_OFFSET);

    *rp1 = r;

    return true;
}

bool create_mosi_pin(rp1_t *rp1, uint32_t funcmask)
{
    uint8_t mosi_pin_number = 10;
    gpio_pin_t *newpin = calloc(1, sizeof(gpio_pin_t));
    if(newpin == NULL) return false;

    newpin->number = mosi_pin_number;

    // each gpio has a status and control register
    // adjacent to each other. control = status + 4 (uint8_t)
    newpin->status = (uint32_t *)(rp1->gpio_base + 8 * mosi_pin_number);
    newpin->ctrl = (uint32_t *)(rp1->gpio_base + 8 * mosi_pin_number + 4);
    newpin->pad = (uint32_t *)(rp1->pads_base + PADS_BANK0_GPIO_OFFSET + mosi_pin_number * 4);

    // set the function
    *(newpin->ctrl + RP1_ATOM_CLR_OFFSET / 4) = CTRL_MASK_FUNCSEL; // first clear the bits
    *(newpin->ctrl + RP1_ATOM_SET_OFFSET / 4) = funcmask;  // now set the value we need

    rp1->pins[mosi_pin_number] = newpin;
    //printf("pin %d stored in pins array %p\n", mosi_pin_number, rp1->pins[mosi_pin_number]);

    return true;
}

rp1_spi_instance_t *spi;

int data_length = 0;
uint8_t* data;

void close_strip()
{
    // disable the SPI
    *(volatile uint32_t *)(spi->regbase + DW_SPI_SSIENR) = 0x0;
    free(data);
}

uint8_t* initialize_strip(int leds_count)
{
    data_length = leds_count * 3;
    data = (uint8_t*) malloc(leds_count * 3);
    /////////////////////////////////////////////////////////
    // RP1

    // get the peripheral base address
    void *base = mapgpio(RP1_BAR1, RP1_BAR1_LEN);
    if (base == NULL) {
        printf("unable to map base\n");
    }

    // create a rp1 device
    // printf("creating rp1\n");
    rp1_t *rp1;
    if (!create_rp1(&rp1, base))
    {
        printf("unable to create rp1\n");
    }


    /////////////////////////////////////////////////////////
    // SPI

    // create a spi instance
    if (!rp1_spi_create(rp1, 0, &spi))
    {
        printf("unable to create spi\n");
    }

    close_strip();

    create_mosi_pin(rp1, 0x00); // MOSI is all we need anyways

    // set the speed - this is the divisor from 200MHz in the RPi5
    *(volatile uint32_t *)(spi->regbase + DW_SPI_BAUDR) = 20; // 10 MHz
    // printf("\nbaudr: %d MHz\n", 200/(*(volatile uint32_t *)(spi->regbase + DW_SPI_BAUDR)));

    // set mode - CPOL = 0, CPHA = 1 (Mode 1)
    // printf("Setting SPI to Mode 1\n");
    // read control
    uint32_t reg_ctrlr0 = *(volatile uint32_t *)(spi->regbase + DW_SPI_CTRLR0);
    // printf("ctrlr0 before setting: %x\n", reg_ctrlr0);
    reg_ctrlr0 |= DW_PSSI_CTRLR0_SCPHA;
    // update the control reg
    *(volatile uint32_t *)(spi->regbase + DW_SPI_CTRLR0) = reg_ctrlr0;
    reg_ctrlr0 = *(volatile uint32_t *)(spi->regbase + DW_SPI_CTRLR0);
    // printf("ctrlr0 after setting (might be the same as before if mode was already set): %x\n", reg_ctrlr0);

    // clear interrupts by reading the interrupt status register
    uint32_t reg_icr = *(volatile uint32_t *)(spi->regbase + DW_SPI_ICR);
    // printf("icr: %x\n", reg_icr);

    // enable the SPI
    *(volatile uint32_t *)(spi->regbase + DW_SPI_SSIENR) = 0x1;

    return data;
}

void render_strip() {
    rp1_spi_write_array_blocking(spi, data, data_length);
}
